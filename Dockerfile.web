# syntax=docker/dockerfile:1.7

# Shared base image with pnpm configured
FROM node:24-alpine AS base

ENV NODE_OPTIONS=--no-network-family-autoselection
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0

RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

WORKDIR /repo

FROM base AS build

ARG VITE_SERVER_URL="https://localhost:3000"
ENV VITE_SERVER_URL=$VITE_SERVER_URL

COPY ./package.json ./pnpm-lock.yaml ./.npmrc ./pnpm-workspace.yaml ./
COPY ./turbo.json ./
## Disable Git hooks installation in container builds
# The repo's "prepare": "lefthook install" needs git; skip it in Docker.
RUN sed -i 's/"prepare": "lefthook install"/"prepare": ""/' package.json
COPY ./apps ./apps
COPY ./packages ./packages

RUN --mount=type=cache,target=/root/.pnpm-store \
	CI=true pnpm install --frozen-lockfile

RUN DO_NOT_TRACK=1 TURBO_TELEMETRY_DISABLED=1 \
	pnpm turbo run build --filter=@iapacte/apps-web

# Runtime image for the TanStack Start SSR server
FROM node:24-alpine AS runner

ENV NODE_OPTIONS=--no-network-family-autoselection
ENV NODE_ENV=production
ENV PORT=3000
ENV NITRO_PORT=3000
ARG VITE_SERVER_URL="https://localhost:3000"
ENV VITE_SERVER_URL=$VITE_SERVER_URL

WORKDIR /app

COPY --from=build /repo/apps/web/.output /app/.output

EXPOSE 3000

CMD ["node", ".output/server/index.mjs"]
