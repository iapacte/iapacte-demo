# Build web assets from the monorepo
FROM node:24-alpine AS build

# Disable the problematic parallel IPv4/IPv6 connection attempts
ENV NODE_OPTIONS=--no-network-family-autoselection

WORKDIR /repo

ENV COREPACK_ENABLE_DOWNLOAD_PROMPT=0
RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

COPY ./package.json ./pnpm-lock.yaml ./.npmrc ./pnpm-workspace.yaml ./
COPY ./turbo.json ./
## Disable Git hooks installation in container builds
# The repo's "prepare": "lefthook install" needs git; skip it in Docker.
RUN sed -i 's/"prepare": "lefthook install"/"prepare": ""/' package.json
COPY ./apps ./apps
COPY ./packages ./packages

RUN --mount=type=cache,target=/root/.pnpm-store CI=true pnpm install --frozen-lockfile

RUN DO_NOT_TRACK=1 TURBO_TELEMETRY_DISABLED=1 pnpm turbo run build --filter=@iapacte/apps-web

# For Tanstack SSR server
FROM node:24-alpine
ENV NODE_OPTIONS=--no-network-family-autoselection
WORKDIR /app
COPY --from=build /repo/apps/web/.output /app/.output
ENV NODE_ENV=production
ENV PORT=3000
CMD ["node", ".output/server/index.mjs"]
